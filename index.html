<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario y Ventas MLF Muebles la familia</title>
    <!-- Importar la fuente Inter de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Importar Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos básicos y fuente */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #374151;
        }

        .container {
            width: 100%;
            max-width: 420px; /* Ancho máximo para simular un smartphone */
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 24px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            color: #1f2937;
            margin-bottom: 24px;
        }

        /* Estilos de navegación con pestañas */
        .tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 0;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            color: #6b7280;
            border: none;
            background-color: transparent;
            cursor: pointer;
            transition: color 0.2s ease, border-bottom 0.2s ease;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }

        /* Estilos de los formularios e inputs */
        .inventory-form, .sales-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
        }

        .form-input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 9999px; /* Bordes totalmente redondeados */
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .form-textarea {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            resize: vertical;
        }
        
        .form-select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 9999px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: white;
            appearance: none; /* Elimina la flecha predeterminada en algunos navegadores */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.25rem;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        .add-button {
            padding: 12px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .add-button:hover {
            background-color: #2563eb;
        }

        .add-button:active {
            transform: scale(0.98);
        }

        /* Estilos para el listado de inventario y ventas */
        .inventory-list, .sales-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .inventory-item, .sales-item {
            display: flex;
            flex-direction: column;
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-name {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .item-sku {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .sales-item .item-actions {
            justify-content: flex-end;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-btn {
            background-color: #e5e7eb;
            color: #4b5563;
            border: none;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .quantity-btn:hover {
            background-color: #d1d5db;
        }

        .item-quantity {
            font-size: 1.25rem;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .delete-button {
            background-color: transparent;
            border: none;
            color: #ef4444;
            font-size: 1rem;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 9999px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .delete-button:hover {
            background-color: #fee2e2;
        }
        
        .edit-button {
            background-color: #f59e0b;
            color: white;
            border: none;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
            padding: 6px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .edit-button:hover {
            background-color: #d97706;
        }
        
        .edit-sale-button {
            background-color: #6366f1;
            color: white;
            border: none;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
            padding: 6px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .edit-sale-button:hover {
            background-color: #4f46e5;
        }

        /* Oculta los elementos al editar */
        .inventory-item[data-editing="true"] .item-content,
        .sales-item[data-editing="true"] .item-content {
            display: none;
        }
        
        /* Muestra el formulario al editar */
        .inventory-item[data-editing="true"] .edit-form,
        .sales-item[data-editing="true"] .edit-form {
            display: flex;
        }
        
        .edit-form {
            display: none;
            flex-direction: column;
            gap: 12px;
        }
        
        .edit-form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .save-button {
            padding: 8px 16px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 9999px;
            font-weight: 700;
            cursor: pointer;
        }
        
        .cancel-button {
            padding: 8px 16px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 9999px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Estilos para la sección de reportes */
        .report-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .report-buttons {
            display: flex;
            gap: 8px;
        }
        
        .report-button {
            flex-grow: 1;
            padding: 12px 20px;
            background-color: #60a5fa;
            color: white;
            border: none;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .report-button:hover {
            background-color: #3b82f6;
        }
        
        .report-content {
            display: none; /* Oculto por defecto */
            background-color: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .report-content.show {
            display: block;
        }
        
        .report-list {
            list-style-type: none;
            padding: 0;
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .report-list li {
            padding: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .report-list li:last-child {
            border-bottom: none;
        }
        
        /* Estilos para los botones de import/export */
        .io-buttons {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }
        
        .io-button {
            flex-grow: 1;
            padding: 12px 20px;
            background-color: #4b5563;
            color: white;
            border: none;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .io-button:hover {
            background-color: #1f2937;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventario MLF Muebles la familia</h1>

        <!-- Navegación de pestañas -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="inventoryTab">Inventario</button>
            <button class="tab-btn" data-tab="salesTab">Gestor de Ventas</button>
        </div>

        <!-- Contenido de la pestaña de Inventario -->
        <div id="inventoryTab" class="tab-content">
            <!-- Campo de búsqueda -->
            <div class="form-group mb-6">
                <label for="searchInput" class="sr-only">Buscar artículo</label>
                <input 
                    type="text" 
                    id="searchInput" 
                    class="form-input" 
                    placeholder="Buscar por nombre o SKU..." 
                />
            </div>
            <!-- Formulario para agregar nuevos artículos -->
            <form id="inventoryForm" class="inventory-form">
                <div class="form-group">
                    <label for="productName">Nombre del producto</label>
                    <input 
                        type="text" 
                        id="productName" 
                        class="form-input" 
                        placeholder="Silla de oficina..." 
                        required 
                    />
                </div>
                <div class="form-group">
                    <label for="sku">SKU</label>
                    <input 
                        type="text" 
                        id="sku" 
                        class="form-input" 
                        placeholder="SKU-12345" 
                        required 
                    />
                </div>
                <div class="form-group">
                    <label for="description">Descripción</label>
                    <textarea 
                        id="description" 
                        class="form-textarea" 
                        placeholder="Escribe una descripción detallada..."
                        rows="3"
                    ></textarea>
                </div>
                <div class="form-group">
                    <label for="cost">Costo</label>
                    <input 
                        type="number" 
                        id="cost" 
                        class="form-input" 
                        value="0" 
                        min="0" 
                        required 
                    />
                </div>
                <div class="form-group">
                    <label for="price">Precio</label>
                    <input 
                        type="number" 
                        id="price" 
                        class="form-input" 
                        value="0" 
                        min="0" 
                        required 
                    />
                </div>
                <div class="form-group">
                    <label for="quantity">Cantidad inicial</label>
                    <input 
                        type="number" 
                        id="quantity" 
                        class="form-input" 
                        value="1" 
                        min="0" 
                        required 
                    />
                </div>
                <button type="submit" class="add-button">Añadir Mueble</button>
            </form>
            
            <!-- Lista donde se mostrarán los artículos -->
            <div id="inventoryList" class="inventory-list">
                <!-- Los artículos se inyectarán aquí dinámicamente -->
            </div>

             <!-- Botones para Importar y Exportar CSV -->
            <div class="io-buttons">
                <button id="exportInventoryBtn" class="io-button">Exportar Inventario (CSV)</button>
                <input type="file" id="importInventoryFile" class="hidden" accept=".csv" />
                <button id="importInventoryBtn" class="io-button">Importar Inventario (CSV)</button>
            </div>

        </div>

        <!-- Contenido de la pestaña de Gestor de Ventas -->
        <div id="salesTab" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-4">Registrar Venta</h2>
            <form id="salesForm" class="sales-form">
                <div id="salesItemsContainer">
                    <div class="form-group flex-row items-center gap-2">
                        <label for="itemSelect-0" class="sr-only">Producto</label>
                        <select id="itemSelect-0" class="form-select w-full" required>
                            <option value="" disabled selected>Selecciona un producto</option>
                        </select>
                        <label for="itemQuantity-0" class="sr-only">Cantidad</label>
                        <input type="number" id="itemQuantity-0" class="form-input w-20" value="1" min="1" required>
                    </div>
                </div>
                <button type="button" id="addSalesItemBtn" class="add-button bg-gray-200 text-gray-800 hover:bg-gray-300">
                    Añadir otro artículo
                </button>
                
                <div class="form-group">
                    <label for="salesObservations">Observaciones (ej. Nombre y celular del cliente)</label>
                    <textarea 
                        id="salesObservations" 
                        class="form-textarea" 
                        placeholder="Escribe aquí los datos del cliente..."
                        rows="3"
                    ></textarea>
                </div>

                <button type="submit" class="add-button">Registrar Venta</button>
            </form>
            
            <h2 class="text-xl font-bold mt-8 mb-4">Historial de Ventas</h2>
            <div id="salesList" class="sales-list">
                 <!-- Las ventas se inyectarán aquí dinámicamente -->
            </div>
            
            <!-- Sección de reportes -->
            <h2 class="text-xl font-bold mt-8 mb-4">Reportes de Ventas</h2>
            <div class="report-section">
                <div class="report-buttons">
                    <button type="button" id="weeklyReportBtn" class="report-button">Reporte Semanal</button>
                    <button type="button" id="monthlyReportBtn" class="report-button">Reporte Mensual</button>
                </div>
                <div id="reportContent" class="report-content">
                    <!-- El reporte se mostrará aquí -->
                </div>
            </div>

            <!-- Botones para Importar y Exportar CSV -->
            <div class="io-buttons">
                <button id="exportSalesBtn" class="io-button">Exportar Ventas (CSV)</button>
                <input type="file" id="importSalesFile" class="hidden" accept=".csv" />
                <button id="importSalesBtn" class="io-button">Importar Ventas (CSV)</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Declaración de variables globales ---
            let inventoryData = JSON.parse(localStorage.getItem('inventory')) || [];
            let salesData = JSON.parse(localStorage.getItem('sales')) || [];

            // --- Selecciona los elementos del DOM ---
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const inventoryForm = document.getElementById('inventoryForm');
            const inventoryList = document.getElementById('inventoryList');
            const searchInput = document.getElementById('searchInput');
            const salesForm = document.getElementById('salesForm');
            const salesList = document.getElementById('salesList');
            const addSalesItemBtn = document.getElementById('addSalesItemBtn');
            const salesItemsContainer = document.getElementById('salesItemsContainer');
            const weeklyReportBtn = document.getElementById('weeklyReportBtn');
            const monthlyReportBtn = document.getElementById('monthlyReportBtn');
            const reportContent = document.getElementById('reportContent');

            // Botones de CSV
            const exportInventoryBtn = document.getElementById('exportInventoryBtn');
            const importInventoryBtn = document.getElementById('importInventoryBtn');
            const importInventoryFile = document.getElementById('importInventoryFile');
            const exportSalesBtn = document.getElementById('exportSalesBtn');
            const importSalesBtn = document.getElementById('importSalesBtn');
            const importSalesFile = document.getElementById('importSalesFile');
            
            // Un contador para los campos de venta dinámicos
            let salesItemCount = 1;

            // --- Funciones de almacenamiento local ---
            function saveInventory() {
                localStorage.setItem('inventory', JSON.stringify(inventoryData));
                renderInventory();
                populateSalesItems();
            }

            function saveSales() {
                localStorage.setItem('sales', JSON.stringify(salesData));
                renderSales();
            }
            
            // --- Funciones de renderizado del DOM ---
            
            function renderInventory(filteredData = inventoryData) {
                inventoryList.innerHTML = '';
                if (filteredData.length === 0) {
                    inventoryList.innerHTML = '<p class="text-center text-gray-500">No hay artículos en el inventario.</p>';
                    return;
                }
                
                filteredData.forEach((item, index) => {
                    const newItem = createInventoryItemElement(item, index);
                    inventoryList.appendChild(newItem);
                });
            }
            
            function renderSales() {
                salesList.innerHTML = '';
                if (salesData.length === 0) {
                    salesList.innerHTML = '<p class="text-center text-gray-500">No hay historial de ventas.</p>';
                    return;
                }
                
                // Muestra las ventas más recientes primero
                salesData.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((sale, index) => {
                    const newSaleItem = createSalesItemElement(sale, index);
                    salesList.appendChild(newSaleItem);
                });
            }

            // Crea el elemento HTML para un artículo del inventario
            function createInventoryItemElement(item, index) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.dataset.index = index;
                // Estado para saber si el artículo está siendo editado
                itemDiv.dataset.editing = 'false';

                itemDiv.innerHTML = `
                    <!-- Contenido de visualización normal -->
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-name">${item.name}</span>
                            <span class="item-sku">SKU: ${item.sku}</span>
                        </div>
                        <div class="item-actions">
                            <div class="quantity-control">
                                <button type="button" class="quantity-btn minus-btn">-</button>
                                <span class="item-quantity">${item.quantity}</span>
                                <button type="button" class="quantity-btn plus-btn">+</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" class="edit-button">Editar</button>
                                <button type="button" class="delete-button">Eliminar</button>
                            </div>
                        </div>
                        <button type="button" class="details-toggle-btn">Mostrar detalles</button>
                        <div class="item-details hidden">
                            <p><strong>Descripción:</strong> ${item.description}</p>
                            <p><strong>Costo:</strong> $${parseFloat(item.cost).toFixed(2)}</p>
                            <p><strong>Precio:</strong> $${parseFloat(item.price).toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <!-- Formulario de edición (inicialmente oculto) -->
                    <form class="edit-form">
                        <div class="form-group">
                            <label for="edit-name-${index}">Nombre del producto</label>
                            <input type="text" id="edit-name-${index}" class="form-input" value="${item.name}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-sku-${index}">SKU</label>
                            <input type="text" id="edit-sku-${index}" class="form-input" value="${item.sku}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-description-${index}">Descripción</label>
                            <textarea id="edit-description-${index}" class="form-textarea" rows="3">${item.description}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-cost-${index}">Costo</label>
                            <input type="number" id="edit-cost-${index}" class="form-input" value="${item.cost}" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-price-${index}">Precio</label>
                            <input type="number" id="edit-price-${index}" class="form-input" value="${item.price}" min="0" required>
                        </div>
                        <div class="edit-form-actions">
                            <button type="button" class="cancel-button">Cancelar</button>
                            <button type="submit" class="save-button">Guardar</button>
                        </div>
                    </form>
                `;
                return itemDiv;
            }
            
            // Crea el elemento HTML para un artículo de venta
            function createSalesItemElement(sale, index) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'sales-item';
                itemDiv.dataset.index = index;
                itemDiv.dataset.editing = 'false';

                const totalProfit = (sale.totalPrice - sale.totalCost).toFixed(2);

                itemDiv.innerHTML = `
                    <!-- Contenido de visualización normal -->
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-name">Venta</span>
                            <span class="item-sku">${new Date(sale.date).toLocaleString()}</span>
                        </div>
                        <div class="item-details">
                            <p><strong>Productos vendidos:</strong></p>
                            <ul>
                                ${sale.products.map(p => `<li>- ${p.name} (SKU: ${p.sku}) x${p.quantity}</li>`).join('')}
                            </ul>
                            <p><strong>Ganancia total:</strong> $${totalProfit}</p>
                            ${sale.observations ? `<p><strong>Observaciones:</strong> ${sale.observations}</p>` : ''}
                        </div>
                        <div class="item-actions mt-4 flex justify-end gap-2">
                            <button type="button" class="edit-sale-button">Editar</button>
                            <button type="button" class="delete-button text-red-500 hover:text-red-700">Eliminar</button>
                        </div>
                    </div>
                    
                    <!-- Formulario de edición (inicialmente oculto) -->
                    <form class="edit-form sales-edit-form">
                        <h3 class="font-bold mb-2">Editar Venta del ${new Date(sale.date).toLocaleString()}</h3>
                        <div class="edit-sales-items-container">
                            <!-- Los campos de productos se inyectarán aquí -->
                        </div>
                        <button type="button" class="add-sales-item-btn bg-gray-200 text-gray-800 hover:bg-gray-300 px-4 py-2 rounded-full mt-2">
                            Añadir otro artículo
                        </button>
                        <div class="form-group mt-4">
                            <label for="edit-sales-observations-${index}">Observaciones</label>
                            <textarea id="edit-sales-observations-${index}" class="form-textarea" rows="3">${sale.observations || ''}</textarea>
                        </div>
                        <div class="edit-form-actions mt-4">
                            <button type="button" class="cancel-button">Cancelar</button>
                            <button type="submit" class="save-button">Guardar</button>
                        </div>
                    </form>
                `;
                return itemDiv;
            }

            // Función auxiliar para crear los campos de selección de productos para el formulario de venta
            function createSalesItemInputs(item, index, container, isEditForm = false) {
                const newSalesItemDiv = document.createElement('div');
                newSalesItemDiv.className = 'form-group flex-row items-center gap-2 mt-2';
                newSalesItemDiv.dataset.index = index;

                const selectId = `itemSelect-${isEditForm ? 'edit-' : ''}${index}`;
                const quantityId = `itemQuantity-${isEditForm ? 'edit-' : ''}${index}`;
                
                let optionsHtml = '<option value="" disabled>Selecciona un producto</option>';
                inventoryData.forEach((invItem, invIndex) => {
                    const isSelected = item && (item.name === invItem.name && item.sku === invItem.sku);
                    const stock = invItem.quantity + (isSelected ? item.quantity : 0);
                    if (stock > 0) {
                        const selectedAttribute = isSelected ? 'selected' : '';
                        optionsHtml += `<option value="${invIndex}" ${selectedAttribute}>${invItem.name} (SKU: ${invItem.sku}, Cantidad: ${invItem.quantity})</option>`;
                    }
                });

                newSalesItemDiv.innerHTML = `
                    <label for="${selectId}" class="sr-only">Producto</label>
                    <select id="${selectId}" class="form-select w-full" required>
                        ${optionsHtml}
                    </select>
                    <label for="${quantityId}" class="sr-only">Cantidad</label>
                    <input type="number" id="${quantityId}" class="form-input w-20" value="${item ? item.quantity : '1'}" min="1" required>
                    <button type="button" class="delete-sales-item-btn text-gray-500 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                container.appendChild(newSalesItemDiv);
            }

            // Función para cambiar de pestaña
            function switchTab(tabId) {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));

                const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
                const activeContent = document.getElementById(tabId);
                
                if (activeBtn) activeBtn.classList.add('active');
                if (activeContent) activeContent.classList.remove('hidden');

                if (tabId === 'salesTab') {
                    populateSalesItems();
                }
            }
            
            // Función para popular el select de productos en el formulario de ventas
            function populateSalesItems() {
                const selects = salesItemsContainer.querySelectorAll('.form-select');
                selects.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="" disabled selected>Selecciona un producto</option>';
                    inventoryData.forEach((item, index) => {
                        if (item.quantity > 0) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${item.name} (SKU: ${item.sku}, Cantidad: ${item.quantity})`;
                            select.appendChild(option);
                        }
                    });
                    if (currentValue && inventoryData[currentValue] && inventoryData[currentValue].quantity > 0) {
                        select.value = currentValue;
                    }
                });
            }
            
            // Función para mostrar mensajes de error/éxito
            function showMessage(message, type = 'success') {
                const messageBox = document.createElement('div');
                messageBox.textContent = message;
                let bgColor = '#10b981'; // Tailwind green-500
                if (type === 'error') {
                    bgColor = '#ef4444'; // Tailwind red-500
                }
                messageBox.style.cssText = `
                    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                    background-color: ${bgColor}; color: white; padding: 12px 20px; border-radius: 9999px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000;
                    text-align: center;
                `;
                document.body.appendChild(messageBox);
                setTimeout(() => { messageBox.remove(); }, 3000);
            }

            function showErrorMessage(message) {
                showMessage(message, 'error');
            }

            // --- Funciones de Reportes ---
            
            function generateReport(period) {
                const now = new Date();
                let startDate;
                let title;

                if (period === 'weekly') {
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(now.setDate(diff));
                    startDate.setHours(0, 0, 0, 0);
                    title = `Reporte Semanal (del ${startDate.toLocaleDateString()})`;
                } else if (period === 'monthly') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    startDate.setHours(0, 0, 0, 0);
                    title = `Reporte Mensual (${now.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })})`;
                }

                const filteredSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate;
                });
                
                if (filteredSales.length === 0) {
                     reportContent.classList.remove('show');
                     showMessage('No hay ventas registradas en este período.', 'info');
                     return;
                }

                let totalSales = 0;
                let totalProfit = 0;
                const productSales = {};

                filteredSales.forEach(sale => {
                    totalSales += sale.totalPrice;
                    totalProfit += (sale.totalPrice - sale.totalCost);

                    sale.products.forEach(product => {
                        const key = `${product.name} - ${product.sku}`;
                        if (!productSales[key]) {
                            productSales[key] = 0;
                        }
                        productSales[key] += product.quantity;
                    });
                });

                const sortedProducts = Object.entries(productSales)
                    .map(([name, quantity]) => ({ name, quantity }))
                    .sort((a, b) => b.quantity - a.quantity);
                    
                renderReport({
                    title: title,
                    totalSales: totalSales,
                    totalProfit: totalProfit,
                    mostSoldProducts: sortedProducts
                });
            }

            function renderReport(reportData) {
                reportContent.innerHTML = `
                    <h3 class="text-lg font-bold mb-2">${reportData.title}</h3>
                    <p><strong>Ventas totales:</strong> $${reportData.totalSales.toFixed(2)}</p>
                    <p><strong>Ganancia total:</strong> $${reportData.totalProfit.toFixed(2)}</p>
                    <h4 class="font-semibold mt-4 mb-2">Productos más vendidos:</h4>
                    <ol class="report-list">
                        ${reportData.mostSoldProducts.map(p => `<li>${p.name} - **${p.quantity} unidades**</li>`).join('')}
                    </ol>
                `;
                reportContent.classList.add('show');
            }
            
            // --- Funciones de CSV ---
            
            function exportToCsv(data, filename) {
                const header = Object.keys(data[0]).join(',');
                const rows = data.map(item => Object.values(item).map(value => {
                    // Si el valor es un objeto o array, lo serializamos a JSON para que se guarde en una sola celda
                    if (typeof value === 'object' && value !== null) {
                        return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
                    }
                    // Si el valor contiene comas o comillas, lo encerramos entre comillas
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(','));

                const csvContent = [header, ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function importFromCsv(file, type) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const headers = lines[0].split(',');
                    const newData = [];

                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Separar por comas pero ignorar las que están dentro de comillas dobles
                        if (values.length !== headers.length) {
                            showErrorMessage(`Error en la línea ${i + 1}: el número de columnas no coincide.`);
                            return;
                        }

                        const item = {};
                        for (let j = 0; j < headers.length; j++) {
                            let value = values[j].trim();
                            // Si el valor empieza y termina con comillas dobles, las quitamos
                            if (value.startsWith('"') && value.endsWith('"')) {
                                value = value.substring(1, value.length - 1).replace(/""/g, '"');
                            }
                            // Intenta parsear a JSON si parece un objeto o array
                            if (value.startsWith('[') || value.startsWith('{')) {
                                try {
                                    item[headers[j]] = JSON.parse(value);
                                } catch (e) {
                                    item[headers[j]] = value;
                                }
                            } else if (!isNaN(value) && value.trim() !== '') {
                                item[headers[j]] = Number(value);
                            } else {
                                item[headers[j]] = value;
                            }
                        }
                        newData.push(item);
                    }
                    
                    if (type === 'inventory') {
                        inventoryData = newData;
                        saveInventory();
                        showMessage('Inventario importado con éxito.');
                    } else if (type === 'sales') {
                        salesData = newData;
                        saveSales();
                        showMessage('Ventas importadas con éxito.');
                    }
                };
                reader.readAsText(file);
            }


            // --- Manejo de eventos ---
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    switchTab(tabId);
                });
            });

            inventoryForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const productName = document.getElementById('productName').value.trim();
                const sku = document.getElementById('sku').value.trim();
                const description = document.getElementById('description').value.trim();
                const cost = parseFloat(document.getElementById('cost').value);
                const price = parseFloat(document.getElementById('price').value);
                const quantity = parseInt(document.getElementById('quantity').value, 10);

                if (productName !== '' && sku !== '' && !isNaN(quantity) && quantity >= 0 && !isNaN(cost) && cost >= 0 && !isNaN(price) && price >= 0) {
                    const newItem = {
                        id: Date.now(), // Usamos un ID único basado en el timestamp
                        name: productName,
                        sku: sku,
                        description: description,
                        cost: cost,
                        price: price,
                        quantity: quantity
                    };
                    
                    inventoryData.push(newItem);
                    saveInventory();
                    inventoryForm.reset();
                    document.getElementById('quantity').value = "1";
                    document.getElementById('cost').value = "0";
                    document.getElementById('price').value = "0";
                    showMessage('¡Mueble añadido con éxito!');
                }
            });

            inventoryList.addEventListener('click', function(e) {
                const target = e.target;
                const itemElement = target.closest('.inventory-item');
                if (!itemElement) return;

                const index = parseInt(itemElement.dataset.index, 10);
                const item = inventoryData[index];

                if (target.classList.contains('delete-button')) {
                    inventoryData.splice(index, 1);
                    saveInventory();
                    showMessage('¡Mueble eliminado!');
                } else if (target.classList.contains('minus-btn')) {
                    if (item.quantity > 0) {
                        item.quantity--;
                        saveInventory();
                    }
                } else if (target.classList.contains('plus-btn')) {
                    item.quantity++;
                    saveInventory();
                } else if (target.classList.contains('details-toggle-btn')) {
                    const details = itemElement.querySelector('.item-details');
                    details.classList.toggle('hidden');
                    target.textContent = details.classList.contains('hidden') ? 'Mostrar detalles' : 'Ocultar detalles';
                } else if (target.classList.contains('edit-button')) {
                    itemElement.dataset.editing = 'true';
                } else if (target.classList.contains('cancel-button')) {
                    itemElement.dataset.editing = 'false';
                    renderInventory(); // Para revertir cualquier cambio en el formulario
                } else if (target.classList.contains('save-button')) {
                    e.preventDefault();

                    const newName = document.getElementById(`edit-name-${index}`).value.trim();
                    const newSku = document.getElementById(`edit-sku-${index}`).value.trim();
                    const newDescription = document.getElementById(`edit-description-${index}`).value.trim();
                    const newCost = parseFloat(document.getElementById(`edit-cost-${index}`).value);
                    const newPrice = parseFloat(document.getElementById(`edit-price-${index}`).value);
                    
                    if (newName !== '' && newSku !== '' && !isNaN(newCost) && newCost >= 0 && !isNaN(newPrice) && newPrice >= 0) {
                        item.name = newName;
                        item.sku = newSku;
                        item.description = newDescription;
                        item.cost = newCost;
                        item.price = newPrice;
                        saveInventory();
                        itemElement.dataset.editing = 'false';
                        showMessage('¡Artículo actualizado con éxito!');
                    } else {
                        showErrorMessage('Por favor, completa todos los campos requeridos y asegúrate de que los valores sean válidos.');
                    }
                }
            });

            salesList.addEventListener('click', function(e) {
                const target = e.target;
                const saleElement = target.closest('.sales-item');
                if (!saleElement) return;

                const index = parseInt(saleElement.dataset.index, 10);
                const sale = salesData[index];

                if (target.classList.contains('edit-sale-button')) {
                    saleElement.dataset.editing = 'true';
                    const editFormContainer = saleElement.querySelector('.edit-sales-items-container');
                    editFormContainer.innerHTML = '';
                    
                    sale.products.forEach((product, productIndex) => {
                        const invItemIndex = inventoryData.findIndex(inv => inv.name === product.name && inv.sku === product.sku);
                        createSalesItemInputs(product, productIndex, editFormContainer, true);
                    });
                } else if (target.classList.contains('cancel-button')) {
                    saleElement.dataset.editing = 'false';
                } else if (target.classList.contains('delete-button')) {
                    // Devolver los productos al inventario antes de eliminar la venta
                    sale.products.forEach(soldProduct => {
                        const invItem = inventoryData.find(inv => inv.name === soldProduct.name && inv.sku === soldProduct.sku);
                        if (invItem) {
                            invItem.quantity += soldProduct.quantity;
                        }
                    });
                    salesData.splice(index, 1);
                    saveInventory();
                    saveSales();
                    showMessage('¡Venta eliminada!');
                } else if (target.classList.contains('add-sales-item-btn')) {
                    const editFormContainer = saleElement.querySelector('.edit-sales-items-container');
                    createSalesItemInputs(null, editFormContainer.children.length, editFormContainer, true);
                } else if (e.target.closest('.delete-sales-item-btn')) {
                    const itemDiv = e.target.closest('.form-group');
                    if (itemDiv) {
                        itemDiv.remove();
                    }
                }
            });

            salesList.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!e.target.classList.contains('sales-edit-form')) return;

                const saleElement = e.target.closest('.sales-item');
                const index = parseInt(saleElement.dataset.index, 10);
                const oldSale = salesData[index];
                
                const newProducts = [];
                let newTotalCost = 0;
                let newTotalPrice = 0;
                let isValidUpdate = true;
                
                // Revertir el stock de la venta anterior
                oldSale.products.forEach(oldProduct => {
                    const invItem = inventoryData.find(inv => inv.name === oldProduct.name && inv.sku === oldProduct.sku);
                    if (invItem) {
                        invItem.quantity += oldProduct.quantity;
                    }
                });

                const salesItemInputs = saleElement.querySelectorAll('.edit-sales-items-container .form-group');

                for (const itemInput of salesItemInputs) {
                    const select = itemInput.querySelector('select');
                    const quantityInput = itemInput.querySelector('input[type="number"]');

                    if (!select || !quantityInput || !select.value || parseInt(quantityInput.value, 10) <= 0) {
                        isValidUpdate = false;
                        break;
                    }
                    
                    const itemIndex = parseInt(select.value, 10);
                    const quantityToSell = parseInt(quantityInput.value, 10);
                    const inventoryItem = inventoryData[itemIndex];
                    
                    if (quantityToSell > inventoryItem.quantity) {
                        showErrorMessage(`No hay suficiente stock de ${inventoryItem.name}. Stock disponible: ${inventoryItem.quantity}`);
                        isValidUpdate = false;
                        break;
                    }

                    newProducts.push({
                        name: inventoryItem.name,
                        sku: inventoryItem.sku,
                        quantity: quantityToSell,
                        cost: inventoryItem.cost,
                        price: inventoryItem.price,
                    });

                    newTotalCost += inventoryItem.cost * quantityToSell;
                    newTotalPrice += inventoryItem.price * quantityToSell;
                    
                    inventoryItem.quantity -= quantityToSell;
                }

                if (isValidUpdate && newProducts.length > 0) {
                    salesData[index] = {
                        ...oldSale,
                        products: newProducts,
                        totalCost: newTotalCost,
                        totalPrice: newTotalPrice,
                        observations: document.getElementById(`edit-sales-observations-${index}`).value.trim(),
                    };
                    saveInventory();
                    saveSales();
                    saleElement.dataset.editing = 'false';
                    showMessage('¡Venta actualizada con éxito!');
                } else {
                    // Si algo falla, revertir los cambios de stock y mostrar error
                    salesData[index].products.forEach(oldProduct => {
                        const invItem = inventoryData.find(inv => inv.name === oldProduct.name && inv.sku === oldProduct.sku);
                        if (invItem) {
                            invItem.quantity -= oldProduct.quantity;
                        }
                    });
                    saveInventory();
                    showErrorMessage('Error al actualizar la venta. Revisa los campos.');
                }
            });


            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                const filtered = inventoryData.filter(item => 
                    item.name.toLowerCase().includes(query) || 
                    item.sku.toLowerCase().includes(query)
                );
                renderInventory(filtered);
            });

            weeklyReportBtn.addEventListener('click', () => generateReport('weekly'));
            monthlyReportBtn.addEventListener('click', () => generateReport('monthly'));

            addSalesItemBtn.addEventListener('click', () => {
                createSalesItemInputs(null, salesItemsContainer.children.length, salesItemsContainer);
            });

            salesItemsContainer.addEventListener('click', function(e) {
                if (e.target.closest('.delete-sales-item-btn')) {
                    const itemDiv = e.target.closest('.form-group');
                    if (itemDiv) {
                        itemDiv.remove();
                    }
                }
            });

            salesForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const soldProducts = [];
                const salesItemInputs = salesItemsContainer.querySelectorAll('.form-group');
                const observations = document.getElementById('salesObservations').value.trim();
                let isValidSale = true;

                let totalSaleCost = 0;
                let totalSalePrice = 0;

                for (const itemInput of salesItemInputs) {
                    const select = itemInput.querySelector('select');
                    const quantityInput = itemInput.querySelector('input[type="number"]');

                    if (!select || !quantityInput || !select.value || parseInt(quantityInput.value, 10) <= 0) {
                        isValidSale = false;
                        break;
                    }

                    const itemIndex = parseInt(select.value, 10);
                    const quantityToSell = parseInt(quantityInput.value, 10);
                    const inventoryItem = inventoryData[itemIndex];
                    
                    if (quantityToSell > inventoryItem.quantity) {
                        showErrorMessage(`No hay suficiente stock de ${inventoryItem.name}. Stock actual: ${inventoryItem.quantity}`);
                        isValidSale = false;
                        break;
                    }

                    soldProducts.push({
                        name: inventoryItem.name,
                        sku: inventoryItem.sku,
                        quantity: quantityToSell,
                        cost: inventoryItem.cost,
                        price: inventoryItem.price,
                    });

                    totalSaleCost += inventoryItem.cost * quantityToSell;
                    totalSalePrice += inventoryItem.price * quantityToSell;

                    inventoryItem.quantity -= quantityToSell;
                }
                
                if (isValidSale && soldProducts.length > 0) {
                    const newSale = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        products: soldProducts,
                        observations: observations,
                        totalCost: totalSaleCost,
                        totalPrice: totalSalePrice,
                    };
                    salesData.push(newSale);
                    saveInventory();
                    saveSales();
                    salesForm.reset();
                    // Limpiar y re-crear el primer campo de venta
                    salesItemsContainer.innerHTML = `
                        <div class="form-group flex-row items-center gap-2">
                            <label for="itemSelect-0" class="sr-only">Producto</label>
                            <select id="itemSelect-0" class="form-select w-full" required>
                                <option value="" disabled selected>Selecciona un producto</option>
                            </select>
                            <label for="itemQuantity-0" class="sr-only">Cantidad</label>
                            <input type="number" id="itemQuantity-0" class="form-input w-20" value="1" min="1" required>
                        </div>
                    `;
                    salesItemCount = 1;
                    populateSalesItems();
                    showMessage('¡Venta registrada con éxito!');
                } else if (!isValidSale) {
                    showErrorMessage('Por favor, revisa los campos del formulario de venta.');
                } else {
                    showErrorMessage('Por favor, selecciona al menos un producto para la venta.');
                }
            });

            // Eventos de CSV
            exportInventoryBtn.addEventListener('click', () => {
                if (inventoryData.length > 0) {
                    exportToCsv(inventoryData, 'inventario.csv');
                } else {
                    showErrorMessage('No hay datos en el inventario para exportar.');
                }
            });

            importInventoryBtn.addEventListener('click', () => {
                importInventoryFile.click();
            });
            importInventoryFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importFromCsv(e.target.files[0], 'inventory');
                    e.target.value = ''; // Reset the file input
                }
            });
            
            exportSalesBtn.addEventListener('click', () => {
                if (salesData.length > 0) {
                    exportToCsv(salesData, 'ventas.csv');
                } else {
                    showErrorMessage('No hay datos de ventas para exportar.');
                }
            });

            importSalesBtn.addEventListener('click', () => {
                importSalesFile.click();
            });
            importSalesFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importFromCsv(e.target.files[0], 'sales');
                    e.target.value = ''; // Reset the file input
                }
            });
            
            // --- Inicialización de la aplicación ---
            renderInventory();
            renderSales();
        });
    </script>
</body>
</html>
